{% extends 'base.html' %}

{% block title %}{{ service.name }} - Envents{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <div class="flex items-center text-sm text-gray-500 mb-6">
        <a href="{% url 'home' %}" class="hover:text-indigo-600">Home</a>
        <span class="mx-2">/</span>
        <a href="{% url 'services:service_list' %}" class="hover:text-indigo-600">Services</a>
        <span class="mx-2">/</span>
        <a href="{% url 'services:service_list_by_category' service.category.slug %}" class="hover:text-indigo-600">Services</a>
        <span class="mx-2">/</span>
        <span class="text-gray-700">{{ service.name }}</span>
    </div>

    <div class="bg-white rounded-lg overflow-hidden shadow-md">
        <div class="md:flex">
            <!-- Left column - Photos -->
            <div class="md:w-1/2 p-4 photo-gallery">
                <!-- Main Photo -->
                <div class="mb-4 rounded-lg overflow-hidden main-photo flex justify-center bg-gray-100">
                    {% if service.main_photo %}
                    <img src="{{ service.main_photo.image.url }}" alt="{{ service.name }}" class="cursor-pointer hover:opacity-90 object-contain" style="max-height: 400px; width: auto; max-width: 100%;">
                    {% else %}
                    <img src="https://images.unsplash.com/photo-1511795409834-ef04bbd61622?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" 
                         alt="{{ service.name }}" class="cursor-pointer hover:opacity-90 object-contain" style="max-height: 400px; width: auto; max-width: 100%;">
                    {% endif %}
                </div>
                
                <!-- Photo Gallery -->
                <div class="flex flex-wrap gap-2 thumbnails-container">
                    {% for photo in service.photos.all %}
                    <div class="rounded-lg overflow-hidden thumbnail flex-grow-0" style="flex-basis: calc(25% - 6px);">
                        <img src="{{ photo.image.url }}" alt="{{ photo.caption }}" class="w-full h-20 object-cover cursor-pointer hover:opacity-80" 
                             data-full-src="{{ photo.image.url }}">
                    </div>
                    {% empty %}
                    <!-- Display placeholder images if no photos -->
                    {% for i in "1234" %}
                    <div class="rounded-lg overflow-hidden thumbnail flex-grow-0" style="flex-basis: calc(25% - 6px);">
                        <img src="https://source.unsplash.com/random/300x200?events&sig={{ i }}" alt="Gallery image" 
                             class="w-full h-20 object-cover cursor-pointer hover:opacity-80">
                    </div>
                    {% endfor %}
                    {% endfor %}
                </div>
            </div>
            
            <!-- Right column - Service Details -->
            <div class="md:w-1/2 p-6 flex flex-col">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-1">{{ service.name }}</h1>
                        <div class="flex items-center mb-4">
                            <div class="flex text-yellow-400">
                                {% for i in "12345" %}
                                {% if forloop.counter <= avg_rating %}
                                <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24">
                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                                </svg>
                                {% else %}
                                <svg class="w-5 h-5 fill-current text-gray-300" viewBox="0 0 24 24">
                                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                                </svg>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <span class="text-gray-600 ml-2">{{ reviews.count }} reviews</span>
                        </div>
                    </div>
                    
                    {% if user.is_authenticated %}
                    <form method="post" action="{% url 'services:toggle_favorite' service.slug %}" class="mr-2">
                        {% csrf_token %}
                        <button type="submit" class="flex items-center justify-center w-10 h-10 rounded-full border border-indigo-600 hover:bg-indigo-50">
                            {% if is_favorite %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                                </svg>
                            {% else %}
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            {% endif %}
                        </button>
                    </form>
                    {% endif %}
                </div>
                
                <!-- Package Options -->
                {% if packages %}
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3">Available Packages</h3>
                    <div class="space-y-3">
                        {% for package in packages %}
                        <div class="border rounded-lg p-4 hover:border-indigo-500 cursor-pointer package-option {% if forloop.first %}bg-indigo-50 border-indigo-500 selected{% endif %}" data-package-id="{{ package.id }}" data-package-price="{{ package.price }}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-medium text-gray-800">{{ package.name }}</h4>
                                    {% if package.description %}
                                    <p class="text-sm text-gray-600 mt-1">{{ package.description }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-lg font-semibold text-indigo-600">৳{{ package.price }}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% else %}
                <!-- Price when no packages are available -->
                <div class="bg-gray-100 rounded-lg p-4 mb-6">
                    <div class="flex items-baseline">
                        <span class="text-3xl font-bold text-indigo-600">৳{{ service.base_price }}</span>
                        <span class="text-gray-500 ml-2">{{ service.price_type }}</span>
                    </div>
                </div>
                {% endif %}
                
                <!-- Details -->
                <div class="prose prose-indigo mb-6">
                    <h3 class="text-xl font-semibold mb-2">About this service</h3>
                    <p class="text-gray-600">{{ service.description }}</p>
                </div>
                
                <!-- Category -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2">Category</h3>
                    <span class="inline-block bg-indigo-100 text-indigo-800 text-sm px-3 py-1 rounded-full">
                        {{ service.category.name }}
                    </span>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-auto">
                    <a href="{% url 'bookings:create_service_booking' %}?service_id={{ service.id }}" 
                       class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded text-center block">
                        Book Now
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Reviews Section -->
        <div class="border-t border-gray-200 p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Customer Reviews</h2>
            
            <!-- Review Form -->
            {% if user.is_authenticated %}
                {% include 'components/review_form.html' with form_action=request.path|add:'submit-review/' object_type='service' %}
            {% else %}
                <div class="mb-6 bg-gray-50 p-4 rounded-lg text-center">
                    <p>Please <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="text-indigo-600 hover:underline">log in</a> to leave a review.</p>
                </div>
            {% endif %}
            
            <!-- Review List -->
            {% include 'components/review_list.html' with reviews=reviews avg_rating=avg_rating %}
        </div>
        
        <!-- Related Services -->
        {% if related_services %}
        <div class="border-t border-gray-200 p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Related Services</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for related in related_services %}
                <div class="bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200 hover:shadow-md transition duration-300">
                    <!-- Service Image -->
                    <div class="h-40 overflow-hidden">
                        {% if related.main_photo %}
                        <img src="{{ related.main_photo.image.url }}" alt="{{ related.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <img src="https://source.unsplash.com/random/300x200?events&sig={{ forloop.counter }}" 
                             alt="{{ related.name }}" class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    
                    <!-- Service Info -->
                    <div class="p-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">{{ related.name }}</h3>
                        <div class="text-indigo-600 font-medium mb-3">৳{{ related.base_price }} <span class="text-gray-500 text-sm">{{ related.price_type }}</span></div>
                        <a href="{% url 'services:service_detail' related.slug %}" class="text-indigo-600 hover:text-indigo-800 font-medium text-sm">View Details →</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function contactProvider() {
        alert("Contact form will be shown here. This feature is not implemented in the mock-up.");
    }

    // Package selection functionality
    document.addEventListener('DOMContentLoaded', function() {
        const packageOptions = document.querySelectorAll('.package-option');
        
        // Add click event for package selection
        packageOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all packages
                packageOptions.forEach(p => {
                    p.classList.remove('selected');
                    p.classList.remove('bg-indigo-50');
                    p.classList.remove('border-indigo-500');
                });
                
                // Add selected class to clicked package
                this.classList.add('selected');
                this.classList.add('bg-indigo-50');
                this.classList.add('border-indigo-500');
                
                // Store selected package ID and price in hidden input
                const packageId = this.getAttribute('data-package-id');
                const packagePrice = this.getAttribute('data-package-price');
                
                // Update any form fields or booking URL with the selected package
                const bookNowBtn = document.querySelector('a.bg-indigo-600');
                if (bookNowBtn) {
                    let href = bookNowBtn.getAttribute('href');
                    // Strip any existing parameters
                    href = href.split('?')[0];
                    // Make sure to include both service_id and package_id
                    const serviceId = '{{ service.id }}';
                    bookNowBtn.setAttribute('href', `${href}?service_id=${serviceId}&package_id=${packageId}`);
                }
            });
        });
        
        // The gallery initialization is now handled by lightbox.js
    }
    });
</script>
{% endblock %}