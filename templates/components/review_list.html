{% comment %}
  Enhanced Review List Component - Simplified Design
  
  Expected context variables:
  - reviews: List of review objects
  - user: Current logged-in user
  - avg_rating: Average rating value
{% endcomment %}

<div class="review-section">
    <!-- Review Stats Section -->
    {% if reviews %}
    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
        <div class="p-5 border-b border-gray-100">
            <h3 class="font-bold text-lg text-gray-800">Customer Feedback</h3>
        </div>
        
        <div class="p-5 flex items-center">
            <div class="text-center mr-6">
                <!-- Average Rating Display -->
                <div class="text-5xl font-bold text-indigo-600">{{ avg_rating|floatformat:1 }}</div>
                <p class="text-sm text-gray-500 mt-1">{{ reviews.count }} review{% if reviews.count != 1 %}s{% endif %}</p>
            </div>
        </div>
    </div>
    
    <!-- Filter & Sort Controls -->
    <div class="flex flex-wrap justify-between items-center mb-4">
        <div class="flex flex-wrap items-center gap-2 text-sm">
            <span class="font-medium text-gray-700">Filter:</span>
            <button class="filter-btn px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50 hover:border-indigo-300 bg-indigo-50 border-indigo-300 text-indigo-700">All ({{ reviews.count }})</button>
            <button class="filter-btn px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50 hover:border-indigo-300">5★</button>
            <button class="filter-btn px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50 hover:border-indigo-300">4★</button>
            <button class="filter-btn px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50 hover:border-indigo-300">3★</button>
            <button class="filter-btn px-3 py-1 border border-gray-300 rounded-full hover:bg-indigo-50 hover:border-indigo-300">1-2★</button>
        </div>
        <div class="mt-3 md:mt-0">
            <select id="review-sort" class="text-sm border border-gray-300 rounded-md px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="newest">Newest First</option>
                <option value="oldest">Oldest First</option>
                <option value="highest">Highest Rated</option>
                <option value="lowest">Lowest Rated</option>
            </select>
        </div>
    </div>
    
    <!-- Review List -->
    <div class="reviews-list space-y-4" id="reviews-container">
        {% for review in reviews %}
        <div class="review-item bg-white rounded-lg shadow-sm overflow-hidden p-5 transition-all duration-200 hover:shadow-md" data-rating="{{ review.rating }}">
            <div class="flex-grow">
                <div class="flex justify-between items-start">
                    <div>
                        <h4 class="font-semibold text-gray-800">{{ review.user.get_full_name|default:review.user.username }}</h4>
                        <div class="flex items-center mt-1">
                            <div class="flex">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= review.rating %}
                                    <svg class="w-4 h-4 text-yellow-400" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                                    </svg>
                                    {% else %}
                                    <svg class="w-4 h-4 text-gray-300" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>
                                    </svg>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <span class="ml-1 text-xs text-gray-500">{{ review.created_at|date:"F d, Y" }}</span>
                        </div>
                    </div>
                    
                    {% if user == review.user %}
                    <div class="flex space-x-2">
                        <button class="edit-review-btn p-1 text-gray-400 hover:text-indigo-600" title="Edit your review">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                        </button>
                        <button class="delete-review-btn p-1 text-gray-400 hover:text-red-500" title="Delete your review">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                    {% endif %}
                </div>
                
                <div class="mt-2 text-gray-700 text-sm">
                    <p>{{ review.comment }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Load More Reviews Button (if applicable) -->
    {% if reviews.count > 5 %}
    <div class="text-center mt-6">
        <button id="load-more-reviews" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-6 rounded-lg transition duration-150">
            Load More Reviews
        </button>
    </div>
    {% endif %}
    {% else %}
    <!-- No Reviews State -->
    <div class="bg-white rounded-lg shadow-sm p-8 text-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        <h3 class="font-semibold text-lg text-gray-700 mb-1">No Reviews Yet</h3>
        <p class="text-gray-500 mb-4">Be the first to share your experience</p>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reviewContainer = document.getElementById('reviews-container');
    const filterButtons = document.querySelectorAll('.filter-btn');
    const sortSelect = document.getElementById('review-sort');
    const loadMoreBtn = document.getElementById('load-more-reviews');
    
    if (!reviewContainer) return;
    
    // Initially show only 5 reviews
    const allReviews = reviewContainer.querySelectorAll('.review-item');
    let visibleCount = 5;
    
    function updateVisibility() {
        let index = 0;
        allReviews.forEach(review => {
            if (index < visibleCount) {
                review.style.display = '';
            } else {
                review.style.display = 'none';
            }
            index++;
        });
        
        // Hide/show load more button
        if (loadMoreBtn) {
            loadMoreBtn.style.display = visibleCount >= allReviews.length ? 'none' : '';
        }
    }
    
    // Load more reviews
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
            visibleCount += 5;
            updateVisibility();
        });
    }
    
    // Filter reviews
    if (filterButtons) {
        filterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                // Update active state
                filterButtons.forEach(b => b.classList.remove('bg-indigo-50', 'border-indigo-300', 'text-indigo-700'));
                this.classList.add('bg-indigo-50', 'border-indigo-300', 'text-indigo-700');
                
                // Reset visible count
                visibleCount = 5;
                
                // Filter logic
                const filter = this.textContent.trim();
                allReviews.forEach(review => {
                    const rating = parseInt(review.dataset.rating);
                    
                    if (filter.includes('All')) {
                        review.dataset.filtered = 'false';
                    } else if (filter === '5★' && rating === 5) {
                        review.dataset.filtered = 'false';
                    } else if (filter === '4★' && rating === 4) {
                        review.dataset.filtered = 'false';
                    } else if (filter === '3★' && rating === 3) {
                        review.dataset.filtered = 'false';
                    } else if (filter === '1-2★' && (rating === 1 || rating === 2)) {
                        review.dataset.filtered = 'false';
                    } else {
                        review.dataset.filtered = 'true';
                        review.style.display = 'none';
                    }
                });
                
                // Show filtered reviews
                let visibleIndex = 0;
                allReviews.forEach(review => {
                    if (review.dataset.filtered === 'false' && visibleIndex < visibleCount) {
                        review.style.display = '';
                        visibleIndex++;
                    } else {
                        review.style.display = 'none';
                    }
                });
                
                // Update load more button visibility
                if (loadMoreBtn) {
                    const filteredTotal = Array.from(allReviews).filter(r => r.dataset.filtered === 'false').length;
                    loadMoreBtn.style.display = visibleIndex >= filteredTotal ? 'none' : '';
                }
            });
        });
    }
    
    // Sort reviews
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            const sortValue = this.value;
            const reviews = Array.from(allReviews);
            
            reviews.sort((a, b) => {
                const aRating = parseInt(a.dataset.rating);
                const bRating = parseInt(b.dataset.rating);
                const aDate = new Date(a.querySelector('.text-xs.text-gray-500').textContent);
                const bDate = new Date(b.querySelector('.text-xs.text-gray-500').textContent);
                
                if (sortValue === 'newest') {
                    return bDate - aDate;
                } else if (sortValue === 'oldest') {
                    return aDate - bDate;
                } else if (sortValue === 'highest') {
                    return bRating === aRating ? bDate - aDate : bRating - aRating;
                } else if (sortValue === 'lowest') {
                    return aRating === bRating ? bDate - aDate : aRating - bRating;
                }
                return 0;
            });
            
            // Re-append sorted reviews
            reviews.forEach(review => {
                reviewContainer.appendChild(review);
            });
            
            // Reset visibility
            visibleCount = 5;
            updateVisibility();
        });
    }
    
    // Set initial visibility
    updateVisibility();
});
</script>